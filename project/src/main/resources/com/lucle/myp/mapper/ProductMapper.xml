<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lucle.myp.mapper.ProductMapper">

	<insert id="insertProduct"
		parameterType="com.lucle.myp.domain.MarketVo">
		<!-- INSERT INTO MARKET (num, PRODUCTNAME, MARKETNAME, URL, IMGURL, WON, 
			DELIVERY, DELIVERYFEE, KEYWORD, VISIBLE, GROUPBUYING, DESCRIPTION) VALUES 
			(seq_market.nextval, #{productName}, #{marketName}, #{url}, #{imgUrl}, #{won}, 
			null, null, #{keyword}, 1, 1, #{description}) -->

		BEGIN
		INSERT INTO MARKET (num, PRODUCTNAME, MARKETNAME, URL,
		IMGURL,
		WON, DELIVERY,
		DELIVERYFEE, KEYWORD, VISIBLE, GROUPBUYING,
		DESCRIPTION)
		VALUES (seq_market.nextval, #{productName}, #{marketName},
		#{url},
		#{imgUrl}, #{won},
		null, null, #{keyword}, 1, 1,
		#{description});

		INSERT
		INTO CATEGORY (LARGE, MEDIUM, SMALL, SUB_CATEGORY, NUM)
		VALUES
		(#{large}, #{medium}, #{small},
		#{sub_category}, seq_market.CURRVAL);
		END;
	</insert>

	<select id="selectAllProducts"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT *
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		JOIN
		GROUPBUYING g ON m.NUM = g.NUM
		ORDER BY m.NUM ASC
	</select>

	<select id="selectProductById" parameterType="int"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT * FROM MARKET WHERE NUM = #{num} AND VISIBLE = 1
	</select>

	<update id="updateProduct"
		parameterType="com.lucle.myp.domain.MarketVo">
		UPDATE MARKET
		SET PRODUCTNAME = #{productName},
		MARKETNAME = #{marketName},
		URL = #{url},
		IMGURL = #{imgUrl},
		WON =
		#{won},
		DELIVERY = #{delivery},
		DELIVERYFEE = #{deliveryFee},
		KEYWORD =
		#{keyword},
		VISIBLE = #{visible},
		GROUPBUYING = #{groupBuying},
		DESCRIPTION = #{description}
		WHERE NUM = #{num}
	</update>

	<delete id="deleteProductById" parameterType="int">
		DELETE FROM MARKET
		WHERE NUM = #{num}
	</delete>

	<select id="getProductDetails"
		resultType="com.lucle.myp.domain.MarketVo">
		<![CDATA[
SELECT sub.*, DENSE_RANK() OVER (ORDER BY CATEGORY_VIEW_COUNT DESC) as CATEGORY_RANK
FROM (
  SELECT M.*, MV.VNO, MV.VIEWDATE, MV.PCATEGORY, G.TITLE, G.CONTENT, G.REGIDATE, G.GOALDATE, G.GOALTARGET, G.PERSONNUM, C.LARGE, C.MEDIUM, C.SMALL, C.SUB_CATEGORY, c.catecode, c.catename, c.tier, c.cateparent, c.cno,
    COUNT(MV.PCATEGORY) OVER (PARTITION BY MV.PCATEGORY) as CATEGORY_VIEW_COUNT,
    ROW_NUMBER() OVER (PARTITION BY M.NUM ORDER BY MV.VNO) as rn
  FROM MARKET M
  JOIN MARKETVIEW MV ON M.NUM = MV.NUM
  JOIN GROUPBUYING G ON M.NUM = G.NUM
  JOIN CATEGORY C ON M.NUM = C.NUM
  WHERE MV.PCATEGORY IS NOT NULL
  GROUP BY M.NUM, M.PRODUCTNAME, M.MARKETNAME, M.URL, M.IMGURL, M.WON, M.DELIVERY, M.DELIVERYFEE, M.KEYWORD, M.VISIBLE, M.GROUPBUYING, M.DESCRIPTION, m.category, MV.VNO, MV.ID, MV.VIEWDATE, MV.VISIBLE, MV.PCATEGORY, G.GNO, G.TITLE, G.CONTENT, G.REGIDATE, G.GOALDATE, G.GOALTARGET, G.PERSONNUM, G.NUM, C.LARGE, C.MEDIUM, C.SMALL, C.SUB_CATEGORY, C.NUM, c.catecode, c.catename, c.tier, c.cateparent, c.cno
) sub
WHERE sub.rn = 1
ORDER BY CATEGORY_RANK, sub.NUM
		]]>
	</select>

	<select id="selectProductsByLargeCategory"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT m.*, c.LARGE, g.*
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		LEFT JOIN GROUPBUYING g ON m.NUM = g.NUM
		WHERE c.LARGE = #{large}
	</select>

	<select id="selectProductsByMediumCategory"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT m.*, c.MEDIUM, g.*
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		LEFT JOIN GROUPBUYING g ON m.NUM = g.NUM
		WHERE c.MEDIUM = #{medium}
	</select>

	<select id="selectProductsBySmallCategory"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT m.*, c.SMALL, g.*
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		LEFT JOIN GROUPBUYING g ON m.NUM = g.NUM
		WHERE c.SMALL = #{small}
	</select>

	<select id="selectProductsBySubCategory"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT m.*, c.SUB_CATEGORY, g.*
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		LEFT JOIN GROUPBUYING g ON m.NUM = g.NUM
		WHERE c.SUB_CATEGORY = #{sub_category}
	</select>

	<select id="cateList" resultType="com.lucle.myp.domain.MarketVo">

		select * from category order by catecode

	</select>

	<select id="findProductsByCategory"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT
  market_query.*
FROM (
  SELECT
    m.NUM AS MARKET_NUM,
    m.PRODUCTNAME,
    m.MARKETNAME,
    m.URL,
    m.IMGURL,
    m.WON,
    m.DELIVERY,
    m.DELIVERYFEE,
    m.KEYWORD,
    m.VISIBLE AS MARKET_VISIBLE,
    m.GROUPBUYING,
    m.DESCRIPTION,
    m.CATEGORY AS MARKET_CATEGORY,
    c.LARGE AS CATEGORY_LARGE,
    c.MEDIUM AS CATEGORY_MEDIUM,
    c.SMALL AS CATEGORY_SMALL,
    c.SUB_CATEGORY AS CATEGORY_SUB_CATEGORY,
    c.TIER,
    c.CATENAME,
    c.CATECODE,
    c.CATEPARENT,
    c.CNO,
    g.GNO,
    g.TITLE AS GROUPBUYING_TITLE,
    g.CONTENT AS GROUPBUYING_CONTENT,
    g.REGIDATE AS GROUPBUYING_REGIDATE,
    g.GOALDATE,
    g.GOALTARGET,
    g.PERSONNUM,
    g.NUM AS GROUPBUYING_NUM,
    ROW_NUMBER() OVER(PARTITION BY m.PRODUCTNAME ORDER BY m.NUM) AS rn
  FROM
    MARKET m
    JOIN CATEGORY c ON m.CATEGORY = c.CATECODE
    JOIN GROUPBUYING g ON m.NUM = g.NUM
  WHERE
    c.CATECODE = #{cateCode}
) market_query
WHERE
  market_query.rn = 1
	</select>
	
	<select id="rankedViewByUser"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT
		market_query.*,
		F.Frequency,
		F.CategoryRank
		FROM (
		SELECT
		m.NUM AS MARKET_NUM,
		m.PRODUCTNAME,
		m.MARKETNAME,
		m.URL,
		m.IMGURL,
		m.WON,
		m.DELIVERY,
		m.DELIVERYFEE,
		m.KEYWORD,
		m.VISIBLE AS MARKET_VISIBLE,
		m.GROUPBUYING,
		m.DESCRIPTION,
		m.CATEGORY AS MARKET_CATEGORY,
		c.LARGE AS CATEGORY_LARGE,
		c.MEDIUM AS CATEGORY_MEDIUM,
		c.SMALL AS CATEGORY_SMALL,
		c.SUB_CATEGORY AS CATEGORY_SUB_CATEGORY,
		c.TIER,
		c.CATENAME,
		c.CATECODE,
		c.CATEPARENT,
		c.CNO,
		g.GNO,
		g.TITLE AS GROUPBUYING_TITLE,
		g.CONTENT AS GROUPBUYING_CONTENT,
		g.REGIDATE AS GROUPBUYING_REGIDATE,
		g.GOALDATE,
		g.GOALTARGET,
		g.PERSONNUM,
		g.NUM AS GROUPBUYING_NUM,
		ROW_NUMBER() OVER(PARTITION BY m.PRODUCTNAME ORDER BY m.NUM) AS rn
		FROM
		MARKET m
		JOIN CATEGORY c ON m.num = c.num
		JOIN GROUPBUYING g ON m.NUM = g.NUM
		) market_query
		JOIN (
		SELECT
		MV.PCATEGORY,
		COUNT(*) AS Frequency,
		ROW_NUMBER() OVER(PARTITION BY MV.PCATEGORY ORDER BY COUNT(*) DESC) AS
		CategoryRank
		FROM
		MARKETVIEW MV
		JOIN USERS U ON MV.ID = U.ID
		WHERE
		U.ID = #{id}
		GROUP BY
		MV.PCATEGORY
		) F ON market_query.MARKET_CATEGORY = F.PCATEGORY
		WHERE
		market_query.rn = 1
		ORDER BY
		F.Frequency DESC, F.CategoryRank
	</select>

</mapper>
