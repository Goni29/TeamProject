<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lucle.myp.mapper.MarketMapper">

	<select id="getList" resultType="com.lucle.myp.domain.MarketVo">
		SELECT
		M.*,
		(
		SELECT COUNT(*)
		FROM
		MARKETVIEW MV
		WHERE MV.NUM = M.NUM
		) AS MARKETVIEWCOUNT
		FROM
		MARKET M
		WHERE
		(
		SOUNDEX(M.PRODUCTNAME) = SOUNDEX(#{keyword})
		OR
		UPPER(M.PRODUCTNAME) LIKE '%' || UPPER(#{keyword}) || '%'
		OR
		UPPER(M.KEYWORD) LIKE '%' || UPPER(#{keyword}) || '%'
		)
	</select>


	<!-- proto 쿼리 수정: MARKET, MarketView, Category 테이블 조인 (viewDate 제외) -->
	<select id="proto" resultType="com.lucle.myp.domain.MarketVo">
	<![CDATA[
		SELECT 
		    M.*,
		    MV.latestVNO,
		    C.Large AS LARGE, 
		    C.Medium AS MEDIUM, 
		    C.Small AS SMALL
		FROM 
    		MARKET M
		LEFT JOIN 
    		(SELECT NUM, MAX(VNO) AS latestVNO FROM MARKETVIEW GROUP BY NUM) MV ON M.NUM = MV.NUM
		LEFT JOIN 
    		Category C ON M.NUM = C.Num
	]]>
	</select>


	<select id="sortProto"
		resultType="com.lucle.myp.domain.MarketVo">
	<![CDATA[
		SELECT A.*, C.Large AS LARGE, C.Medium AS MEDIUM, C.Small AS SMALL
		FROM (
    		SELECT M.*, ROW_NUMBER() OVER (PARTITION BY M.MARKETNAME ORDER BY M.WON) AS RN
    			FROM MARKET M
    			WHERE M.KEYWORD = #{keyword, jdbcType=VARCHAR}
			 ) A
		LEFT JOIN Category C ON A.NUM = C.Num
		WHERE A.RN = 1
	]]>
	</select>


	<!-- <select id="groupBuying" resultType="com.lucle.myp.domain.MarketVo"> 
		<![CDATA[ SELECT * FROM MARKET WHERE GROUPBUYING = 1 ORDER BY DBMS_RANDOM.VALUE 
		]]> </select> -->

	<select id="groupBuying"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT
		AVG_MK.NUM,
		AVG_MK.MARKETNAME,
		AVG_MK.PRODUCTNAME,
		AVG_MK.URL,
		AVG_MK.IMGURL,
		AVG_MK.WON,
		AVG_MK.KEYWORD,
		C.Large AS LARGE,
		C.Medium AS MEDIUM,
		C.Small AS SMALL
		FROM (
		SELECT
		m.NUM,
		M.MARKETNAME,
		M.PRODUCTNAME,
		M.URL,
		M.IMGURL,
		M.WON,
		M.KEYWORD,
		ABS(M.WON - MK_AVG.AVG_PRICE) AS PRICE_DIFFERENCE,
		ROW_NUMBER() OVER (
		PARTITION BY M.KEYWORD
		ORDER BY ABS(M.WON - MK_AVG.AVG_PRICE)
		) AS RN
		FROM
		MARKET M
		INNER JOIN (
		SELECT
		KEYWORD,
		AVG(WON) AS AVG_PRICE
		FROM
		MARKET
		WHERE
		MARKETNAME IN ('Amazon', 'Amazon Japan', 'Ebay', '11번가')
		GROUP BY
		KEYWORD
		) MK_AVG ON M.KEYWORD = MK_AVG.KEYWORD
		WHERE
		M.MARKETNAME IN ('Amazon', 'Amazon Japan', 'Ebay', '11번가')
		) AVG_MK
		LEFT JOIN Category C ON AVG_MK.Num = C.Num -- 조인 조건 확인 필요
		WHERE
		AVG_MK.RN = 1
	</select>



	<insert id="marketViewPlus">
		insert into marketView(vno, id, num, viewDate,
		visible)
		values(seq_marketView.nextval, #{id}, #{num}, sysdate, 1)
	</insert>

	<select id="getHistoryOne"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT MV.*, M.*
		FROM MARKETVIEW MV
		INNER JOIN MARKET M ON
		MV.NUM = M.NUM
		WHERE MV.ID = #{id}
		ORDER BY viewDate DESC
	</select>

	<select id="getHistoryProduct"
		resultType="com.lucle.myp.domain.MarketVo">
		select *
		from marketView
		where num = #{num}
		order by viewDate
		desc
	</select>

</mapper>