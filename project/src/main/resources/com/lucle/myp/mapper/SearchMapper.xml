<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lucle.myp.mapper.SearchMapper">
	<insert id="insert">
		insert into search(sno, id, searchWord, searchDate,
		visible, ip)
		values(seq_search.nextval, #{id, jdbcType=VARCHAR}, #{searchWord}, sysdate,
		1, #{ip})
	</insert>

	<update id="delete">
		update search
		set visible = 0
		where sno = #{sno}
	</update>

	<select id="getCountList"
		resultType="com.lucle.myp.domain.SearchVo">
		select searchWord, count(*) as searchCount
		from search
		where
		searchDate >= sysdate - #{sortTime}
		group by searchWord
		order by
		searchCount desc
	</select>
<!-- 
	<select id="getStatList"
		resultType="com.lucle.myp.domain.SearchStatVo">
		<![CDATA[
SELECT   s.SEARCHWORD,   
         COUNT(*) AS SEARCHCOUNT,   
         SUM(CASE WHEN u.AGE BETWEEN 10 AND 19 THEN 1 ELSE 0 END) AS teens,   
         SUM(CASE WHEN u.AGE BETWEEN 20 AND 29 THEN 1 ELSE 0 END) AS twenties,   
         SUM(CASE WHEN u.AGE BETWEEN 30 AND 39 THEN 1 ELSE 0 END) AS thirties,   
         SUM(CASE WHEN u.AGE BETWEEN 40 AND 49 THEN 1 ELSE 0 END) AS forties,   
         SUM(CASE WHEN u.AGE BETWEEN 50 AND 59 THEN 1 ELSE 0 END) AS fifties,   
         SUM(CASE WHEN u.AGE >= 60 THEN 1 ELSE 0 END) AS above,   
         SUM(CASE WHEN u.GENDER = 1 THEN 1 ELSE 0 END) AS male,   
         SUM(CASE WHEN u.GENDER = 0 THEN 1 ELSE 0 END) AS female,   
         SUM(CASE WHEN u.ADDRESS = '서울특별시' THEN 1 ELSE 0 END) AS SEOUL,   
         SUM(CASE WHEN u.ADDRESS = '경기도' THEN 1 ELSE 0 END) AS GYEONGGI   
FROM     USERS u   
JOIN     SEARCH s ON u.ID = s.ID   
WHERE    searchDate >= sysdate - #{sortTime}
GROUP BY s.SEARCHWORD
ORDER BY ${sort} DESC
		]]>
	</select> -->
	
	<select id="getMarketviewList"
		resultType="com.lucle.myp.domain.MarketviewVo">
		<![CDATA[
SELECT
    mv.pcategory,
    COUNT(*) AS marketViewCount,
    SUM(CASE WHEN u.AGE <= 9 THEN 1 ELSE 0 END) AS underteens,
    SUM(CASE WHEN u.AGE BETWEEN 10 AND 19 THEN 1 ELSE 0 END) AS teens,
    SUM(CASE WHEN u.AGE BETWEEN 20 AND 29 THEN 1 ELSE 0 END) AS twenties,
    SUM(CASE WHEN u.AGE BETWEEN 30 AND 39 THEN 1 ELSE 0 END) AS thirties,
    SUM(CASE WHEN u.AGE BETWEEN 40 AND 49 THEN 1 ELSE 0 END) AS forties,
    SUM(CASE WHEN u.AGE BETWEEN 50 AND 59 THEN 1 ELSE 0 END) AS fifties,
    SUM(CASE WHEN u.AGE >= 60 THEN 1 ELSE 0 END) AS sixtiesover,
    SUM(CASE WHEN u.GENDER = 1 THEN 1 ELSE 0 END) AS male,
    SUM(CASE WHEN u.GENDER = 0 THEN 1 ELSE 0 END) AS female,
    SUM(CASE WHEN u.ADDRESS = '서울특별시' THEN 1 ELSE 0 END) AS seoul,
    SUM(CASE WHEN u.ADDRESS = '인천광역시' THEN 1 ELSE 0 END) AS incheon,
    SUM(CASE WHEN u.ADDRESS = '부산광역시' THEN 1 ELSE 0 END) AS busan,
    SUM(CASE WHEN u.ADDRESS = '대구광역시' THEN 1 ELSE 0 END) AS deagu,
    SUM(CASE WHEN u.ADDRESS = '광주광역시' THEN 1 ELSE 0 END) AS gwangju,
    SUM(CASE WHEN u.ADDRESS = '대전광역시' THEN 1 ELSE 0 END) AS deajeon,
    SUM(CASE WHEN u.ADDRESS = '울산광역시' THEN 1 ELSE 0 END) AS ulsan,
    SUM(CASE WHEN u.ADDRESS = '경기도' THEN 1 ELSE 0 END) AS gyeonggi,
    SUM(CASE WHEN u.ADDRESS = '강원도' THEN 1 ELSE 0 END) AS gangwon,
    SUM(CASE WHEN u.ADDRESS = '충청북도' THEN 1 ELSE 0 END) AS chungbuk,
    SUM(CASE WHEN u.ADDRESS = '충청남도' THEN 1 ELSE 0 END) AS chungnam,
    SUM(CASE WHEN u.ADDRESS = '전라북도' THEN 1 ELSE 0 END) AS jeonbuk,
    SUM(CASE WHEN u.ADDRESS = '전라남도' THEN 1 ELSE 0 END) AS jeonnam,
    SUM(CASE WHEN u.ADDRESS = '경상북도' THEN 1 ELSE 0 END) AS kyeongbuk,
    SUM(CASE WHEN u.ADDRESS = '경상남도' THEN 1 ELSE 0 END) AS kyeongnam
FROM
    USERS u
JOIN
    MARKETVIEW mv ON u.ID = mv.ID
WHERE
    searchDate >= sysdate - #{sortTime}
GROUP BY
    mv.pcategory
ORDER BY
    ${sort} DESC
		]]>
	</select>

	<select id="getOne" resultType="com.lucle.myp.domain.SearchVo">
		select * from search where
		searchWord = #{searchWord}
	</select>

	<select id="getList" resultType="com.lucle.myp.domain.SearchVo">
		select * from search
		order by
		searchCount desc
	</select>

	<select id="getHistoryOne"
		resultType="com.lucle.myp.domain.SearchVo">
		select *
		from search
		where id = #{id}
		order by searchDate desc
	</select>

	<select id="getHistoryOneIp"
		resultType="com.lucle.myp.domain.SearchVo">
		select *
		from search
		where ip = #{ip}
		order by searchDate desc
	</select>
	
	<select id="selectUsersByRegion" resultType="com.lucle.myp.domain.SearchVo">
        SELECT * FROM USERS WHERE Address LIKE CONCAT('%', #{region}, '%')
    </select>


</mapper>