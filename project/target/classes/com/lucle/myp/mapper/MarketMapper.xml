<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lucle.myp.mapper.MarketMapper">

	<select id="getList" resultType="com.lucle.myp.domain.MarketVo">
		SELECT m.*, c.LARGE, c.MEDIUM,
		c.SMALL, c.SUB_CATEGORY
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		WHERE
		(
		UPPER(M.PRODUCTNAME) LIKE '%' || UPPER(#{productName}) || '%'
		)
	</select>


	<!-- proto 쿼리 수정: MARKET, MarketView, Category 테이블 조인 (viewDate 제외) -->
	<select id="proto" resultType="com.lucle.myp.domain.MarketVo">
	<![CDATA[
		SELECT m.*, c.LARGE, c.MEDIUM, c.SMALL, c.SUB_CATEGORY
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
	]]>
	</select>


	<select id="sortProto"
		resultType="com.lucle.myp.domain.MarketVo">
	<![CDATA[
		SELECT m.*, c.LARGE, c.MEDIUM, c.SMALL, c.SUB_CATEGORY
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
		WHERE c.LARGE = #{large} AND c.MEDIUM = #{medium} AND c.SMALL = #{small} AND c.SUB_CATEGORY = #{sub_category} AND m.num = #{num}
	]]>
	</select>


	<!-- <select id="groupBuying" resultType="com.lucle.myp.domain.MarketVo"> 
		<![CDATA[ SELECT * FROM MARKET WHERE GROUPBUYING = 1 ORDER BY DBMS_RANDOM.VALUE 
		]]> </select> -->

	<select id="groupBuying"
		resultType="com.lucle.myp.domain.MarketVo">
	<![CDATA[
		SELECT m.*, c.LARGE, c.MEDIUM, c.SMALL, c.SUB_CATEGORY
		FROM MARKET m
		JOIN CATEGORY c ON m.NUM = c.NUM
	]]>
	</select>



	<insert id="addViewRecord">
		insert into marketView(vno, id, num, viewDate,
		visible, PCATEGORY)
		values(seq_marketView.nextval,
		#{id,jdbcType=VARCHAR}, #{num}, sysdate, 1, null)
	</insert>

	<select id="getHistoryOne"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT MV.*, M.*
		FROM MARKETVIEW MV
		INNER JOIN MARKET M ON
		MV.NUM = M.NUM
		WHERE MV.ID = #{id}
		ORDER BY viewDate DESC
	</select>

	<select id="getHistoryProduct"
		resultType="com.lucle.myp.domain.MarketVo">
		select *
		from marketView
		where num = #{num}
		order by viewDate
		desc
	</select>

	<select id="getProductById"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT * FROM market WHERE num = #{num}
	</select>

	<select id="rankedView"
		resultType="com.lucle.myp.domain.MarketVo">
		SELECT
		M.*,
		F.Frequency,
		C.*
		FROM
		MARKET M
		INNER JOIN (
		SELECT
		NUM,
		COUNT(*) AS Frequency
		FROM
		MARKETVIEW
		GROUP BY
		NUM
		) F ON M.NUM = F.NUM
		LEFT JOIN CATEGORY C ON M.NUM = C.NUM
		ORDER BY
		F.Frequency DESC
	</select>
</mapper>